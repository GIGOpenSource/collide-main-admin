# 权限管理系统使用说明

## 概述

本权限管理系统基于RBAC（基于角色的访问控制）模型设计，提供了完整的权限管理功能，包括权限定义、角色管理、权限分配和权限验证等。

## 系统架构

### 核心组件

1. **权限实体（Permission）**：定义系统中的各种权限
2. **角色实体（Role）**：定义用户角色
3. **角色权限关联（RolePermission）**：管理角色和权限的多对多关系
4. **权限验证拦截器（PermissionInterceptor）**：拦截请求并验证用户权限
5. **权限注解（@RequiresPermission）**：标记需要权限验证的方法

### 权限类型

- **menu**：菜单权限，控制页面访问
- **button**：按钮权限，控制功能按钮显示
- **api**：接口权限，控制API访问

## 数据库设计

### 权限表（t_permission）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 权限ID（主键） |
| name | varchar(100) | 权限名称 |
| code | varchar(100) | 权限编码（唯一标识） |
| type | varchar(20) | 权限类型（menu/button/api） |
| path | varchar(200) | 权限路径 |
| description | varchar(500) | 权限描述 |
| parent_id | bigint | 父级权限ID |
| sort | int | 排序 |
| status | tinyint | 状态（1:启用, 0:禁用） |
| create_time | timestamp | 创建时间 |
| update_time | timestamp | 更新时间 |

### 角色权限关联表（t_role_permission）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| role_id | int | 角色ID |
| permission_id | bigint | 权限ID |
| create_time | timestamp | 创建时间 |
| update_time | timestamp | 更新时间 |

## 使用方法

### 1. 权限定义

在控制器方法上使用`@RequiresPermission`注解来定义权限：

```java
@RequiresPermission(value = "content:blo:query", description = "博主查询权限")
@GetMapping("/query")
public Map<String, Object> queryBlos() {
    // 业务逻辑
    return ResponseUtil.success("查询成功");
}
```

### 2. 权限编码规范

权限编码采用层级结构，使用冒号分隔：

- `system`：系统管理模块
- `system:user`：用户管理子模块
- `system:user:query`：用户查询权限
- `system:user:create`：用户创建权限

### 3. 权限分配

通过权限管理接口为角色分配权限：

```bash
POST /api/admin/permission/assign
{
    "roleId": 1,
    "permissionIds": [1, 2, 3, 4]
}
```

### 4. 权限验证

系统会自动拦截带有`@RequiresPermission`注解的接口，验证用户权限：

- 从请求头`X-User-Role`获取用户角色ID
- 从请求参数`roleId`获取用户角色ID
- 从Session获取用户角色ID

## API接口

### 权限管理接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/admin/permission/tree` | GET | 查询权限树 |
| `/api/admin/permission/role/{roleId}` | GET | 查询角色权限 |
| `/api/admin/permission/create` | POST | 创建权限 |
| `/api/admin/permission/update` | PUT | 更新权限 |
| `/api/admin/permission/delete/{id}` | DELETE | 删除权限 |
| `/api/admin/permission/assign` | POST | 分配角色权限 |
| `/api/admin/permission/role-tree/{roleId}` | GET | 获取角色权限树 |

### 角色管理接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/admin/role/list` | GET | 查询角色列表 |
| `/api/admin/role/create` | POST | 创建角色 |
| `/api/admin/role/delete/{id}` | DELETE | 删除角色 |

## 权限配置

### 拦截器配置

在`PermissionConfig`中配置权限拦截器：

```java
@Configuration
public class PermissionConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(permissionInterceptor)
                .addPathPatterns("/api/**")  // 拦截所有API请求
                .excludePathPatterns(        // 排除不需要权限验证的路径
                        "/api/admin/login",   // 登录接口
                        "/api/admin/register", // 注册接口
                        "/api/public/**",     // 公开接口
                        "/error",             // 错误页面
                        "/favicon.ico"        // 网站图标
                );
    }
}
```

### 权限验证流程

1. 请求到达控制器方法
2. 拦截器检查方法是否有`@RequiresPermission`注解
3. 从请求中获取用户角色ID
4. 查询角色拥有的权限列表
5. 验证是否包含所需权限
6. 验证通过则放行，否则返回403错误

## 初始化数据

系统提供了完整的初始化SQL脚本`permission_tables.sql`，包含：

- 权限表结构
- 角色权限关联表结构
- 基础权限数据
- 角色权限关联数据

执行SQL脚本后，系统将具备：

- 系统管理模块权限
- 内容管理模块权限
- 角色权限关联关系

## 扩展说明

### 自定义权限验证

可以继承`PermissionInterceptor`类，重写权限验证逻辑：

```java
@Component
public class CustomPermissionInterceptor extends PermissionInterceptor {
    
    @Override
    protected boolean hasPermission(Integer roleId, String permissionCode) {
        // 自定义权限验证逻辑
        return super.hasPermission(roleId, permissionCode);
    }
}
```

### 动态权限加载

可以实现动态权限加载，从数据库或缓存中获取权限信息：

```java
@Service
public class DynamicPermissionService {
    
    @Cacheable(value = "permissions", key = "#roleId")
    public List<String> getRolePermissions(Integer roleId) {
        // 从数据库加载权限
        return permissionService.getPermissionsByRoleId(roleId)
                .stream()
                .map(Permission::getCode)
                .collect(Collectors.toList());
    }
}
```

## 注意事项

1. **权限编码唯一性**：权限编码必须全局唯一
2. **角色ID获取**：确保请求中包含正确的用户角色信息
3. **性能考虑**：权限验证会查询数据库，建议使用缓存优化
4. **安全考虑**：权限验证在服务端进行，前端仅用于展示控制
5. **日志记录**：系统会记录权限验证的详细日志，便于问题排查

## 常见问题

### Q: 权限验证失败怎么办？

A: 检查以下几点：
- 用户角色ID是否正确传递
- 角色是否已分配相应权限
- 权限编码是否正确
- 权限状态是否为启用状态

### Q: 如何添加新的权限？

A: 按以下步骤操作：
1. 在数据库中添加权限记录
2. 为相关角色分配新权限
3. 在控制器方法上添加`@RequiresPermission`注解

### Q: 权限验证影响性能怎么办？

A: 可以采取以下优化措施：
1. 使用Redis缓存权限信息
2. 批量查询权限
3. 异步权限验证
4. 权限信息预加载

## 总结

本权限管理系统提供了完整的RBAC权限控制功能，具有以下特点：

- **灵活性**：支持多种权限类型和层级结构
- **易用性**：通过注解即可实现权限控制
- **扩展性**：支持自定义权限验证逻辑
- **安全性**：服务端权限验证，确保系统安全
- **性能性**：支持缓存优化，提升系统性能

通过合理使用本系统，可以有效控制用户访问权限，提升系统安全性和可维护性。
